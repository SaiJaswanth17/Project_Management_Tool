'use strict';

/*!
 * ignore
 */

<<<<<<< HEAD
module.exports = function validateBeforeSave(schema) {
=======
module.exports = function(schema) {
>>>>>>> b27af961a96dd61074668580d2744d16862a539a
  const unshift = true;
  schema.pre('save', false, function validateBeforeSave(next, options) {
    const _this = this;
    // Nested docs have their own presave
<<<<<<< HEAD
    if (this.$isSubdocument) {
=======
    if (this.ownerDocument) {
>>>>>>> b27af961a96dd61074668580d2744d16862a539a
      return next();
    }

    const hasValidateBeforeSaveOption = options &&
        (typeof options === 'object') &&
        ('validateBeforeSave' in options);

    let shouldValidate;
    if (hasValidateBeforeSaveOption) {
      shouldValidate = !!options.validateBeforeSave;
    } else {
      shouldValidate = this.$__schema.options.validateBeforeSave;
    }

    // Validate
    if (shouldValidate) {
      const hasValidateModifiedOnlyOption = options &&
          (typeof options === 'object') &&
          ('validateModifiedOnly' in options);
      const validateOptions = hasValidateModifiedOnlyOption ?
        { validateModifiedOnly: options.validateModifiedOnly } :
        null;
<<<<<<< HEAD
      this.$validate(validateOptions).then(
        () => {
          this.$op = 'save';
          next();
        },
        error => {
          _this.$__schema.s.hooks.execPost('save:error', _this, [_this], { error: error }, function(error) {
            _this.$op = 'save';
            next(error);
          });
        }
      );
=======
      this.validate(validateOptions, function(error) {
        return _this.$__schema.s.hooks.execPost('save:error', _this, [_this], { error: error }, function(error) {
          _this.$op = 'save';
          next(error);
        });
      });
>>>>>>> b27af961a96dd61074668580d2744d16862a539a
    } else {
      next();
    }
  }, null, unshift);
};
